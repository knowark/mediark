from aiohttp import web
from typing import Callable, Type
from validark import normalize
from ..helpers import get_request_filter


class Resource:
    def __init__(self,
                 count_handler: Callable,
                 search_handler: Callable,
                 add_handler: Callable,
                 delete_handler: Callable) -> None:
        self.count_handler = count_handler
        self.search_handler = search_handler
        self.add_handler = add_handler
        self.delete_handler = delete_handler
        self.model = ''

    async def head(self, request) -> web.Response:
        domain, _, _ = await get_request_filter(request)
        total_count = await self.count_handler({
            'meta':{
                'model': 'Media',
                'domain': domain
            }
        })
        print("HEAD>>>>"*50)
        print(type(total_count))
        return web.Response(headers={'Total-Count': str(total_count['data'])})

    async def get(self, request: web.Request) -> web.Response:
        print("ENTRA AL GET>>>>"*50)
        domain, limit, offset = await get_request_filter(request)
        print("EN GET RESOURCE>>>")
        print(domain)
        records = await self.search_handler(model='Media',
            domain=domain, limit=limit, offset=offset)
        return web.json_response(normalize(records))
